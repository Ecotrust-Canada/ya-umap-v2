<!doctype html>

<html><head>

<title>Young Agrarians</title>

<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css">
<link rel="stylesheet" href="../vendor/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="../vendor/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="../vendor/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<link rel="stylesheet" href="../fonts/stylesheet.css">
<link rel="stylesheet" href="../css/marketing.css">

</head><body>

<results></results>
<div id='map'></div>
<button class='submit'>Submit a listing <big>+</big></button>
<layers></layers>
<search></search>
<listing></listing>

<script src="../tags/results.tag" type="riot/tag"></script>
<script src="../tags/search.tag" type="riot/tag"></script>
<script src="../tags/layers.tag" type="riot/tag"></script>
<script src="../tags/listing.tag" type="riot/tag"></script>

<script src="../vendor/riot/riot%2Bcompiler.min.js"></script>
<script src="https://cdn.rawgit.com/fdaciuk/ajax/v1.0.10/dist/ajax.min.js"></script>
<script src="../vendor/leaflet/dist/leaflet-src.js"></script>
<script src="../vendor/leaflet.markercluster/dist/leaflet.markercluster.js"></script>


<script>

var map = L.map('map', {
	center: [49.505, -123],
	zoom: 12,
  zoomControl: false
});

//add zoom control with your options
L.control.zoom({
     position:'bottomleft'
}).addTo(map);

// https: also suppported.
var OpenStreetMap_Mapnik = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	maxZoom: 19,
	attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
});
var OpenStreetMap_BlackAndWhite = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
	maxZoom: 18,
	attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
});

map.addLayer(OpenStreetMap_BlackAndWhite);

map.locate({setView: true, maxZoom: 12});

bounds = map.getBounds();
url = "parks/within?lat1=" + bounds.getSouthWest().lat + "&lon1=" + bounds.getSouthWest().lng + "&lat2=" + bounds.getNorthEast().lat + "&lon2=" + bounds.getNorthEast().lng;	

var geo;


function getSoil(e){
	if (geo) map.removeLayer(geo);
	var bounds = map.getBounds();
	var url = "soil/within?lat1=" + bounds.getSouthWest().lat + "&lon1=" + bounds.getSouthWest().lng + "&lat2=" + bounds.getNorthEast().lat + "&lon2=" + bounds.getNorthEast().lng;
	var request = ajax().get(url).then(function(response){
		geo = {
			"type": "FeatureCollection",
			"features": JSON.parse(response)
		}
		geo = L.geoJson(geo, {
			style:{
				"color": "#ff7800",
				"weight": 5,
				"opacity": 0.65
			}
		}).addTo(map);
	});
}
 
layers = {
	wells:{
    'name': 'wells',
    url: 'http://openmaps.gov.bc.ca/mapserver/freshwater-and-marine',
    overlays: [
      {
        layers: 'GW_WATER_WELLS_WRBC_COMMERCIAL,GW_WATER_WELLS_WRBC_COMMUNITY,GW_WATER_WELLS_WRBC_DOMESTIC,GW_WATER_WELLS_WRBC_DWS,GW_WATER_WELLS_WRBC_IRRIGATION,GW_WATER_WELLS_WRBC_MUNICIPAL,GW_WATER_WELLS_WRBC_ABANDONED',
        label: 'by owner'
      },
      {
        layers: 'GW_WATER_WELLS_WRBC_OBSERVATION_ACTIVE,GW_WATER_WELLS_WRBC_OBSERVATION_INACTIVE,GW_WATER_WELLS_WRBC_OTHER_USE,GW_WATER_WELLS_WRBC_TEST,GW_WATER_WELLS_WRBC_UNKNOWN_USE',
        label: 'by use'
      },
      {
        layers: 'GW_WATER_WELLS_WRBC_WATER_WELLS,GW_WATER_WELLS_WRBC_WATER_UTILITY', // all wells
        label: 'all wells'
      },
      {
        layers: 'GW_WATER_WELLS_WRBC_ARTESIAN', // by technology
        label: 'Artensian Wells, by type'
      }
    ]
	}
};


wms_layers = [];
wms_layers.push({
	layer: L.tileLayer.wms("http://openmaps.gov.bc.ca/mapserver/freshwater-and-marine", {
	  layers: 'GW_WATER_WELLS_WRBC_COMMERCIAL,GW_WATER_WELLS_WRBC_COMMUNITY,GW_WATER_WELLS_WRBC_DOMESTIC,GW_WATER_WELLS_WRBC_DWS,GW_WATER_WELLS_WRBC_IRRIGATION,GW_WATER_WELLS_WRBC_MUNICIPAL,GW_WATER_WELLS_WRBC_ABANDONED',
	  format: 'image/png',
	  transparent: true
	}),
	name: 'wells by owner'
});

wms_layers.push({
	layer: L.tileLayer.wms("http://openmaps.gov.bc.ca/mapserver/freshwater-and-marine", {
	  layers: 'GW_WATER_WELLS_WRBC_OBSERVATION_ACTIVE,GW_WATER_WELLS_WRBC_OBSERVATION_INACTIVE,GW_WATER_WELLS_WRBC_OTHER_USE,GW_WATER_WELLS_WRBC_TEST,GW_WATER_WELLS_WRBC_UNKNOWN_USE',
	  format: 'image/png',
	  transparent: true
	}),
	name: 'wells by use'
});

wms_layers.push({
	layer: L.tileLayer.wms("http://openmaps.gov.bc.ca/mapserver/freshwater-and-marine", {
	  layers: 'GW_WATER_WELLS_WRBC_WATER_WELLS,GW_WATER_WELLS_WRBC_WATER_UTILITY',
	  format: 'image/png',
	  transparent: true
	}),
	name: 'all wells'
});


/*
map.on('dragend', getSoil);
map.on('zoomend', getSoil);
map.whenReady(getSoil);
*/

var pubsub = riot.observable();

riot.mount('results', pubsub);
riot.mount('search', pubsub);
riot.mount('layers', pubsub);
riot.mount('listing', pubsub);

function slug(category){
  return category.name.toLowerCase().replace(/\s/,'-');
}

// add event cross browser
function addEvent(elem, event, fn) {
    // avoid memory overhead of new anonymous functions for every event handler that's installed
    // by using local functions
    function listenHandler(e) {
        var ret = fn.apply(this, arguments);
        if (ret === false) {
            e.stopPropagation();
            e.preventDefault();
        }
        return(ret);
    }

    function attachHandler() {
        // set the this pointer same as addEventListener when fn is called
        // and make sure the event is passed to the fn also so that works the same too
        var ret = fn.call(elem, window.event);   
        if (ret === false) {
            window.event.returnValue = false;
            window.event.cancelBubble = true;
        }
        return(ret);
    }

    if (elem.addEventListener) {
        elem.addEventListener(event, listenHandler, false);
    } else {
        elem.attachEvent("on" + event, attachHandler);
    }
}

// the get-info button.
addEvent(document.body, 'click', function(e){
  if (e.target.className && e.target.className.indexOf('info') > -1) {
  	pubsub.trigger('detail', e.target.getAttribute('data-id'));
  }
})


</script>
</body></html>
